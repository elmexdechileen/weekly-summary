"use strict";var t=require("obsidian"),e=require("node:fs"),r=require("node:path");function n(t,e,r,n){return new(r||(r=Promise))((function(s,i){function o(t){try{u(n.next(t))}catch(t){i(t)}}function a(t){try{u(n.throw(t))}catch(t){i(t)}}function u(t){var e;t.done?s(t.value):(e=t.value,e instanceof r?e:new r((function(t){t(e)}))).then(o,a)}u((n=n.apply(t,e||[])).next())}))}function s(t){return t&&t.__esModule&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}"function"==typeof SuppressedError&&SuppressedError;var i,o={exports:{}};var a,u=(i||(i=1,o.exports=function(){var t=1e3,e=6e4,r=36e5,n="millisecond",s="second",i="minute",o="hour",a="day",u="week",c="month",h="quarter",l="year",d="date",f="Invalid Date",p=/^(\d{4})[-/]?(\d{1,2})?[-/]?(\d{0,2})[Tt\s]*(\d{1,2})?:?(\d{1,2})?:?(\d{1,2})?[.:]?(\d+)?$/,y=/\[([^\]]+)]|Y{1,4}|M{1,4}|D{1,2}|d{1,4}|H{1,2}|h{1,2}|a|A|m{1,2}|s{1,2}|Z{1,2}|SSS/g,m={name:"en",weekdays:"Sunday_Monday_Tuesday_Wednesday_Thursday_Friday_Saturday".split("_"),months:"January_February_March_April_May_June_July_August_September_October_November_December".split("_"),ordinal:function(t){var e=["th","st","nd","rd"],r=t%100;return"["+t+(e[(r-20)%10]||e[r]||e[0])+"]"}},g=function(t,e,r){var n=String(t);return!n||n.length>=e?t:""+Array(e+1-n.length).join(r)+t},w={s:g,z:function(t){var e=-t.utcOffset(),r=Math.abs(e),n=Math.floor(r/60),s=r%60;return(e<=0?"+":"-")+g(n,2,"0")+":"+g(s,2,"0")},m:function t(e,r){if(e.date()<r.date())return-t(r,e);var n=12*(r.year()-e.year())+(r.month()-e.month()),s=e.clone().add(n,c),i=r-s<0,o=e.clone().add(n+(i?-1:1),c);return+(-(n+(r-s)/(i?s-o:o-s))||0)},a:function(t){return t<0?Math.ceil(t)||0:Math.floor(t)},p:function(t){return{M:c,y:l,w:u,d:a,D:d,h:o,m:i,s:s,ms:n,Q:h}[t]||String(t||"").toLowerCase().replace(/s$/,"")},u:function(t){return void 0===t}},b="en",v={};v[b]=m;var $="$isDayjsObject",S=function(t){return t instanceof O||!(!t||!t[$])},E=function t(e,r,n){var s;if(!e)return b;if("string"==typeof e){var i=e.toLowerCase();v[i]&&(s=i),r&&(v[i]=r,s=i);var o=e.split("-");if(!s&&o.length>1)return t(o[0])}else{var a=e.name;v[a]=e,s=a}return!n&&s&&(b=s),s||!n&&b},T=function(t,e){if(S(t))return t.clone();var r="object"==typeof e?e:{};return r.date=t,r.args=arguments,new O(r)},A=w;A.l=E,A.i=S,A.w=function(t,e){return T(t,{locale:e.$L,utc:e.$u,x:e.$x,$offset:e.$offset})};var O=function(){function m(t){this.$L=E(t.locale,null,!0),this.parse(t),this.$x=this.$x||t.x||{},this[$]=!0}var g=m.prototype;return g.parse=function(t){this.$d=function(t){var e=t.date,r=t.utc;if(null===e)return new Date(NaN);if(A.u(e))return new Date;if(e instanceof Date)return new Date(e);if("string"==typeof e&&!/Z$/i.test(e)){var n=e.match(p);if(n){var s=n[2]-1||0,i=(n[7]||"0").substring(0,3);return r?new Date(Date.UTC(n[1],s,n[3]||1,n[4]||0,n[5]||0,n[6]||0,i)):new Date(n[1],s,n[3]||1,n[4]||0,n[5]||0,n[6]||0,i)}}return new Date(e)}(t),this.init()},g.init=function(){var t=this.$d;this.$y=t.getFullYear(),this.$M=t.getMonth(),this.$D=t.getDate(),this.$W=t.getDay(),this.$H=t.getHours(),this.$m=t.getMinutes(),this.$s=t.getSeconds(),this.$ms=t.getMilliseconds()},g.$utils=function(){return A},g.isValid=function(){return!(this.$d.toString()===f)},g.isSame=function(t,e){var r=T(t);return this.startOf(e)<=r&&r<=this.endOf(e)},g.isAfter=function(t,e){return T(t)<this.startOf(e)},g.isBefore=function(t,e){return this.endOf(e)<T(t)},g.$g=function(t,e,r){return A.u(t)?this[e]:this.set(r,t)},g.unix=function(){return Math.floor(this.valueOf()/1e3)},g.valueOf=function(){return this.$d.getTime()},g.startOf=function(t,e){var r=this,n=!!A.u(e)||e,h=A.p(t),f=function(t,e){var s=A.w(r.$u?Date.UTC(r.$y,e,t):new Date(r.$y,e,t),r);return n?s:s.endOf(a)},p=function(t,e){return A.w(r.toDate()[t].apply(r.toDate("s"),(n?[0,0,0,0]:[23,59,59,999]).slice(e)),r)},y=this.$W,m=this.$M,g=this.$D,w="set"+(this.$u?"UTC":"");switch(h){case l:return n?f(1,0):f(31,11);case c:return n?f(1,m):f(0,m+1);case u:var b=this.$locale().weekStart||0,v=(y<b?y+7:y)-b;return f(n?g-v:g+(6-v),m);case a:case d:return p(w+"Hours",0);case o:return p(w+"Minutes",1);case i:return p(w+"Seconds",2);case s:return p(w+"Milliseconds",3);default:return this.clone()}},g.endOf=function(t){return this.startOf(t,!1)},g.$set=function(t,e){var r,u=A.p(t),h="set"+(this.$u?"UTC":""),f=(r={},r[a]=h+"Date",r[d]=h+"Date",r[c]=h+"Month",r[l]=h+"FullYear",r[o]=h+"Hours",r[i]=h+"Minutes",r[s]=h+"Seconds",r[n]=h+"Milliseconds",r)[u],p=u===a?this.$D+(e-this.$W):e;if(u===c||u===l){var y=this.clone().set(d,1);y.$d[f](p),y.init(),this.$d=y.set(d,Math.min(this.$D,y.daysInMonth())).$d}else f&&this.$d[f](p);return this.init(),this},g.set=function(t,e){return this.clone().$set(t,e)},g.get=function(t){return this[A.p(t)]()},g.add=function(n,h){var d,f=this;n=Number(n);var p=A.p(h),y=function(t){var e=T(f);return A.w(e.date(e.date()+Math.round(t*n)),f)};if(p===c)return this.set(c,this.$M+n);if(p===l)return this.set(l,this.$y+n);if(p===a)return y(1);if(p===u)return y(7);var m=(d={},d[i]=e,d[o]=r,d[s]=t,d)[p]||1,g=this.$d.getTime()+n*m;return A.w(g,this)},g.subtract=function(t,e){return this.add(-1*t,e)},g.format=function(t){var e=this,r=this.$locale();if(!this.isValid())return r.invalidDate||f;var n=t||"YYYY-MM-DDTHH:mm:ssZ",s=A.z(this),i=this.$H,o=this.$m,a=this.$M,u=r.weekdays,c=r.months,h=r.meridiem,l=function(t,r,s,i){return t&&(t[r]||t(e,n))||s[r].slice(0,i)},d=function(t){return A.s(i%12||12,t,"0")},p=h||function(t,e,r){var n=t<12?"AM":"PM";return r?n.toLowerCase():n};return n.replace(y,(function(t,n){return n||function(t){switch(t){case"YY":return String(e.$y).slice(-2);case"YYYY":return A.s(e.$y,4,"0");case"M":return a+1;case"MM":return A.s(a+1,2,"0");case"MMM":return l(r.monthsShort,a,c,3);case"MMMM":return l(c,a);case"D":return e.$D;case"DD":return A.s(e.$D,2,"0");case"d":return String(e.$W);case"dd":return l(r.weekdaysMin,e.$W,u,2);case"ddd":return l(r.weekdaysShort,e.$W,u,3);case"dddd":return u[e.$W];case"H":return String(i);case"HH":return A.s(i,2,"0");case"h":return d(1);case"hh":return d(2);case"a":return p(i,o,!0);case"A":return p(i,o,!1);case"m":return String(o);case"mm":return A.s(o,2,"0");case"s":return String(e.$s);case"ss":return A.s(e.$s,2,"0");case"SSS":return A.s(e.$ms,3,"0");case"Z":return s}return null}(t)||s.replace(":","")}))},g.utcOffset=function(){return 15*-Math.round(this.$d.getTimezoneOffset()/15)},g.diff=function(n,d,f){var p,y=this,m=A.p(d),g=T(n),w=(g.utcOffset()-this.utcOffset())*e,b=this-g,v=function(){return A.m(y,g)};switch(m){case l:p=v()/12;break;case c:p=v();break;case h:p=v()/3;break;case u:p=(b-w)/6048e5;break;case a:p=(b-w)/864e5;break;case o:p=b/r;break;case i:p=b/e;break;case s:p=b/t;break;default:p=b}return f?p:A.a(p)},g.daysInMonth=function(){return this.endOf(c).$D},g.$locale=function(){return v[this.$L]},g.locale=function(t,e){if(!t)return this.$L;var r=this.clone(),n=E(t,e,!0);return n&&(r.$L=n),r},g.clone=function(){return A.w(this.$d,this)},g.toDate=function(){return new Date(this.valueOf())},g.toJSON=function(){return this.isValid()?this.toISOString():null},g.toISOString=function(){return this.$d.toISOString()},g.toString=function(){return this.$d.toUTCString()},m}(),x=O.prototype;return T.prototype=x,[["$ms",n],["$s",s],["$m",i],["$H",o],["$W",a],["$M",c],["$y",l],["$D",d]].forEach((function(t){x[t[1]]=function(e){return this.$g(e,t[0],t[1])}})),T.extend=function(t,e){return t.$i||(t(e,O,T),t.$i=!0),T},T.locale=E,T.isDayjs=S,T.unix=function(t){return T(1e3*t)},T.en=v[b],T.Ls=v,T.p={},T}()),o.exports),c=s(u),h={exports:{}};var l,d=s(a?h.exports:(a=1,h.exports=(l="day",function(t,e,r){var n=function(t){return t.add(4-t.isoWeekday(),l)},s=e.prototype;s.isoWeekYear=function(){return n(this).year()},s.isoWeek=function(t){if(!this.$utils().u(t))return this.add(7*(t-this.isoWeek()),l);var e,s,i,o=n(this),a=(e=this.isoWeekYear(),i=4-(s=(this.$u?r.utc:r)().year(e).startOf("year")).isoWeekday(),s.isoWeekday()>4&&(i+=7),s.add(i,l));return o.diff(a,"week")+1},s.isoWeekday=function(t){return this.$utils().u(t)?this.day()||7:this.day(this.day()%7?t:t-7)};var i=s.startOf;s.startOf=function(t,e){var r=this.$utils(),n=!!r.u(e)||e;return"isoweek"===r.p(t)?n?this.date(this.date()-(this.isoWeekday()-1)).startOf("day"):this.date(this.date()-1-(this.isoWeekday()-1)+7).endOf("day"):i.bind(this)(t,e)}}))),f="undefined"!=typeof globalThis&&globalThis||"undefined"!=typeof self&&self||"undefined"!=typeof global&&global||{},p="URLSearchParams"in f,y="Symbol"in f&&"iterator"in Symbol,m="FileReader"in f&&"Blob"in f&&function(){try{return new Blob,!0}catch(t){return!1}}(),g="FormData"in f,w="ArrayBuffer"in f;if(w)var b=["[object Int8Array]","[object Uint8Array]","[object Uint8ClampedArray]","[object Int16Array]","[object Uint16Array]","[object Int32Array]","[object Uint32Array]","[object Float32Array]","[object Float64Array]"],v=ArrayBuffer.isView||function(t){return t&&b.indexOf(Object.prototype.toString.call(t))>-1};function $(t){if("string"!=typeof t&&(t=String(t)),/[^a-z0-9\-#$%&'*+.^_`|~!]/i.test(t)||""===t)throw new TypeError('Invalid character in header field name: "'+t+'"');return t.toLowerCase()}function S(t){return"string"!=typeof t&&(t=String(t)),t}function E(t){var e={next:function(){var e=t.shift();return{done:void 0===e,value:e}}};return y&&(e[Symbol.iterator]=function(){return e}),e}function T(t){this.map={},t instanceof T?t.forEach((function(t,e){this.append(e,t)}),this):Array.isArray(t)?t.forEach((function(t){if(2!=t.length)throw new TypeError("Headers constructor: expected name/value pair to be length 2, found"+t.length);this.append(t[0],t[1])}),this):t&&Object.getOwnPropertyNames(t).forEach((function(e){this.append(e,t[e])}),this)}function A(t){if(!t._noBody)return t.bodyUsed?Promise.reject(new TypeError("Already read")):void(t.bodyUsed=!0)}function O(t){return new Promise((function(e,r){t.onload=function(){e(t.result)},t.onerror=function(){r(t.error)}}))}function x(t){var e=new FileReader,r=O(e);return e.readAsArrayBuffer(t),r}function _(t){if(t.slice)return t.slice(0);var e=new Uint8Array(t.byteLength);return e.set(new Uint8Array(t)),e.buffer}function k(){return this.bodyUsed=!1,this._initBody=function(t){var e;this.bodyUsed=this.bodyUsed,this._bodyInit=t,t?"string"==typeof t?this._bodyText=t:m&&Blob.prototype.isPrototypeOf(t)?this._bodyBlob=t:g&&FormData.prototype.isPrototypeOf(t)?this._bodyFormData=t:p&&URLSearchParams.prototype.isPrototypeOf(t)?this._bodyText=t.toString():w&&m&&((e=t)&&DataView.prototype.isPrototypeOf(e))?(this._bodyArrayBuffer=_(t.buffer),this._bodyInit=new Blob([this._bodyArrayBuffer])):w&&(ArrayBuffer.prototype.isPrototypeOf(t)||v(t))?this._bodyArrayBuffer=_(t):this._bodyText=t=Object.prototype.toString.call(t):(this._noBody=!0,this._bodyText=""),this.headers.get("content-type")||("string"==typeof t?this.headers.set("content-type","text/plain;charset=UTF-8"):this._bodyBlob&&this._bodyBlob.type?this.headers.set("content-type",this._bodyBlob.type):p&&URLSearchParams.prototype.isPrototypeOf(t)&&this.headers.set("content-type","application/x-www-form-urlencoded;charset=UTF-8"))},m&&(this.blob=function(){var t=A(this);if(t)return t;if(this._bodyBlob)return Promise.resolve(this._bodyBlob);if(this._bodyArrayBuffer)return Promise.resolve(new Blob([this._bodyArrayBuffer]));if(this._bodyFormData)throw new Error("could not read FormData body as blob");return Promise.resolve(new Blob([this._bodyText]))}),this.arrayBuffer=function(){if(this._bodyArrayBuffer){var t=A(this);return t||(ArrayBuffer.isView(this._bodyArrayBuffer)?Promise.resolve(this._bodyArrayBuffer.buffer.slice(this._bodyArrayBuffer.byteOffset,this._bodyArrayBuffer.byteOffset+this._bodyArrayBuffer.byteLength)):Promise.resolve(this._bodyArrayBuffer))}if(m)return this.blob().then(x);throw new Error("could not read as ArrayBuffer")},this.text=function(){var t,e,r,n,s,i=A(this);if(i)return i;if(this._bodyBlob)return t=this._bodyBlob,e=new FileReader,r=O(e),n=/charset=([A-Za-z0-9_-]+)/.exec(t.type),s=n?n[1]:"utf-8",e.readAsText(t,s),r;if(this._bodyArrayBuffer)return Promise.resolve(function(t){for(var e=new Uint8Array(t),r=new Array(e.length),n=0;n<e.length;n++)r[n]=String.fromCharCode(e[n]);return r.join("")}(this._bodyArrayBuffer));if(this._bodyFormData)throw new Error("could not read FormData body as text");return Promise.resolve(this._bodyText)},g&&(this.formData=function(){return this.text().then(P)}),this.json=function(){return this.text().then(JSON.parse)},this}T.prototype.append=function(t,e){t=$(t),e=S(e);var r=this.map[t];this.map[t]=r?r+", "+e:e},T.prototype.delete=function(t){delete this.map[$(t)]},T.prototype.get=function(t){return t=$(t),this.has(t)?this.map[t]:null},T.prototype.has=function(t){return this.map.hasOwnProperty($(t))},T.prototype.set=function(t,e){this.map[$(t)]=S(e)},T.prototype.forEach=function(t,e){for(var r in this.map)this.map.hasOwnProperty(r)&&t.call(e,this.map[r],r,this)},T.prototype.keys=function(){var t=[];return this.forEach((function(e,r){t.push(r)})),E(t)},T.prototype.values=function(){var t=[];return this.forEach((function(e){t.push(e)})),E(t)},T.prototype.entries=function(){var t=[];return this.forEach((function(e,r){t.push([r,e])})),E(t)},y&&(T.prototype[Symbol.iterator]=T.prototype.entries);var D=["CONNECT","DELETE","GET","HEAD","OPTIONS","PATCH","POST","PUT","TRACE"];function M(t,e){if(!(this instanceof M))throw new TypeError('Please use the "new" operator, this DOM object constructor cannot be called as a function.');var r,n,s=(e=e||{}).body;if(t instanceof M){if(t.bodyUsed)throw new TypeError("Already read");this.url=t.url,this.credentials=t.credentials,e.headers||(this.headers=new T(t.headers)),this.method=t.method,this.mode=t.mode,this.signal=t.signal,s||null==t._bodyInit||(s=t._bodyInit,t.bodyUsed=!0)}else this.url=String(t);if(this.credentials=e.credentials||this.credentials||"same-origin",!e.headers&&this.headers||(this.headers=new T(e.headers)),this.method=(r=e.method||this.method||"GET",n=r.toUpperCase(),D.indexOf(n)>-1?n:r),this.mode=e.mode||this.mode||null,this.signal=e.signal||this.signal||function(){if("AbortController"in f)return(new AbortController).signal}(),this.referrer=null,("GET"===this.method||"HEAD"===this.method)&&s)throw new TypeError("Body not allowed for GET or HEAD requests");if(this._initBody(s),!("GET"!==this.method&&"HEAD"!==this.method||"no-store"!==e.cache&&"no-cache"!==e.cache)){var i=/([?&])_=[^&]*/;if(i.test(this.url))this.url=this.url.replace(i,"$1_="+(new Date).getTime());else{this.url+=(/\?/.test(this.url)?"&":"?")+"_="+(new Date).getTime()}}}function P(t){var e=new FormData;return t.trim().split("&").forEach((function(t){if(t){var r=t.split("="),n=r.shift().replace(/\+/g," "),s=r.join("=").replace(/\+/g," ");e.append(decodeURIComponent(n),decodeURIComponent(s))}})),e}function B(t,e){if(!(this instanceof B))throw new TypeError('Please use the "new" operator, this DOM object constructor cannot be called as a function.');if(e||(e={}),this.type="default",this.status=void 0===e.status?200:e.status,this.status<200||this.status>599)throw new RangeError("Failed to construct 'Response': The status provided (0) is outside the range [200, 599].");this.ok=this.status>=200&&this.status<300,this.statusText=void 0===e.statusText?"":""+e.statusText,this.headers=new T(e.headers),this.url=e.url||"",this._initBody(t)}M.prototype.clone=function(){return new M(this,{body:this._bodyInit})},k.call(M.prototype),k.call(B.prototype),B.prototype.clone=function(){return new B(this._bodyInit,{status:this.status,statusText:this.statusText,headers:new T(this.headers),url:this.url})},B.error=function(){var t=new B(null,{status:200,statusText:""});return t.ok=!1,t.status=0,t.type="error",t};var j=[301,302,303,307,308];B.redirect=function(t,e){if(-1===j.indexOf(e))throw new RangeError("Invalid status code");return new B(null,{status:e,headers:{location:t}})};var C=f.DOMException;try{new C}catch(t){(C=function(t,e){this.message=t,this.name=e;var r=Error(t);this.stack=r.stack}).prototype=Object.create(Error.prototype),C.prototype.constructor=C}function R(t,e){return new Promise((function(r,n){var s=new M(t,e);if(s.signal&&s.signal.aborted)return n(new C("Aborted","AbortError"));var i=new XMLHttpRequest;function o(){i.abort()}if(i.onload=function(){var t,e,n={statusText:i.statusText,headers:(t=i.getAllResponseHeaders()||"",e=new T,t.replace(/\r?\n[\t ]+/g," ").split("\r").map((function(t){return 0===t.indexOf("\n")?t.substr(1,t.length):t})).forEach((function(t){var r=t.split(":"),n=r.shift().trim();if(n){var s=r.join(":").trim();try{e.append(n,s)}catch(t){console.warn("Response "+t.message)}}})),e)};0===s.url.indexOf("file://")&&(i.status<200||i.status>599)?n.status=200:n.status=i.status,n.url="responseURL"in i?i.responseURL:n.headers.get("X-Request-URL");var o="response"in i?i.response:i.responseText;setTimeout((function(){r(new B(o,n))}),0)},i.onerror=function(){setTimeout((function(){n(new TypeError("Network request failed"))}),0)},i.ontimeout=function(){setTimeout((function(){n(new TypeError("Network request timed out"))}),0)},i.onabort=function(){setTimeout((function(){n(new C("Aborted","AbortError"))}),0)},i.open(s.method,function(t){try{return""===t&&f.location.href?f.location.href:t}catch(e){return t}}(s.url),!0),"include"===s.credentials?i.withCredentials=!0:"omit"===s.credentials&&(i.withCredentials=!1),"responseType"in i&&(m?i.responseType="blob":w&&(i.responseType="arraybuffer")),e&&"object"==typeof e.headers&&!(e.headers instanceof T||f.Headers&&e.headers instanceof f.Headers)){var a=[];Object.getOwnPropertyNames(e.headers).forEach((function(t){a.push($(t)),i.setRequestHeader(t,S(e.headers[t]))})),s.headers.forEach((function(t,e){-1===a.indexOf(e)&&i.setRequestHeader(e,t)}))}else s.headers.forEach((function(t,e){i.setRequestHeader(e,t)}));s.signal&&(s.signal.addEventListener("abort",o),i.onreadystatechange=function(){4===i.readyState&&s.signal.removeEventListener("abort",o)}),i.send(void 0===s._bodyInit?null:s._bodyInit)}))}R.polyfill=!0,f.fetch||(f.fetch=R,f.Headers=T,f.Request=M,f.Response=B);const U="11434",F=`http://127.0.0.1:${U}`;var W=Object.defineProperty,N=(t,e,r)=>(((t,e,r)=>{e in t?W(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r})(t,"symbol"!=typeof e?e+"":e,r),r);class L extends Error{constructor(t,e){super(t),this.error=t,this.status_code=e,this.name="ResponseError",Error.captureStackTrace&&Error.captureStackTrace(this,L)}}class I{constructor(t,e,r){N(this,"abortController"),N(this,"itr"),N(this,"doneCallback"),this.abortController=t,this.itr=e,this.doneCallback=r}abort(){this.abortController.abort()}async*[Symbol.asyncIterator](){for await(const t of this.itr){if("error"in t)throw new Error(t.error);if(yield t,t.done||"success"===t.status)return void this.doneCallback()}throw new Error("Did not receive done or success response in stream.")}}const H=async t=>{if(t.ok)return;let e=`Error ${t.status}: ${t.statusText}`,r=null;if(t.headers.get("content-type")?.includes("application/json"))try{r=await t.json(),e=r.error||e}catch(t){console.log("Failed to parse error response as JSON")}else try{console.log("Getting text from response");e=await t.text()||e}catch(t){console.log("Failed to get text from error response")}throw new L(e,t.status)};function q(){if("undefined"!=typeof window&&window.navigator){const t=navigator;return"userAgentData"in t&&t.userAgentData?.platform?`${t.userAgentData.platform.toLowerCase()} Browser/${navigator.userAgent};`:navigator.platform?`${navigator.platform.toLowerCase()} Browser/${navigator.userAgent};`:`unknown Browser/${navigator.userAgent};`}return"undefined"!=typeof process?`${process.arch} ${process.platform} Node.js/${process.version}`:""}const Y=async(t,e,r={})=>{const n={"Content-Type":"application/json",Accept:"application/json","User-Agent":`ollama-js/0.5.15 (${q()})`};r.headers=function(t){if(t instanceof Headers){const e={};return t.forEach(((t,r)=>{e[r]=t})),e}return Array.isArray(t)?Object.fromEntries(t):t||{}}(r.headers);const s=Object.fromEntries(Object.entries(r.headers).filter((([t])=>!Object.keys(n).some((e=>e.toLowerCase()===t.toLowerCase())))));return r.headers={...n,...s},t(e,r)},V=async(t,e,r)=>{const n=await Y(t,e,{headers:r?.headers});return await H(n),n},z=async(t,e,r,n)=>{const s=null===(i=r)||"object"!=typeof i||Array.isArray(i)?r:JSON.stringify(r);var i;const o=await Y(t,e,{method:"POST",body:s,signal:n?.signal,headers:n?.headers});return await H(o),o};var J=Object.defineProperty,G=(t,e,r)=>(((t,e,r)=>{e in t?J(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r})(t,"symbol"!=typeof e?e+"":e,r),r);let Z=class{constructor(t){G(this,"config"),G(this,"fetch"),G(this,"ongoingStreamedRequests",[]),this.config={host:"",headers:t?.headers},t?.proxy||(this.config.host=(t=>{if(!t)return F;let e=t.includes("://");t.startsWith(":")&&(t=`http://127.0.0.1${t}`,e=!0),e||(t=`http://${t}`);const r=new URL(t);let n=r.port;n||(n=e?"https:"===r.protocol?"443":"80":U);let s="";r.username&&(s=r.username,r.password&&(s+=`:${r.password}`),s+="@");let i=`${r.protocol}//${s}${r.hostname}:${n}${r.pathname}`;return i.endsWith("/")&&(i=i.slice(0,-1)),i})(t?.host??F)),this.fetch=t?.fetch??fetch}abort(){for(const t of this.ongoingStreamedRequests)t.abort();this.ongoingStreamedRequests.length=0}async processStreamableRequest(t,e){e.stream=e.stream??!1;const r=`${this.config.host}/api/${t}`;if(e.stream){const t=new AbortController,n=await z(this.fetch,r,e,{signal:t.signal,headers:this.config.headers});if(!n.body)throw new Error("Missing body");const s=async function*(t){const e=new TextDecoder("utf-8");let r="";const n=t.getReader();for(;;){const{done:t,value:s}=await n.read();if(t)break;r+=e.decode(s);const i=r.split("\n");r=i.pop()??"";for(const t of i)try{yield JSON.parse(t)}catch(e){console.warn("invalid json: ",t)}}for(const t of r.split("\n").filter((t=>""!==t)))try{yield JSON.parse(t)}catch(e){console.warn("invalid json: ",t)}}(n.body),i=new I(t,s,(()=>{const t=this.ongoingStreamedRequests.indexOf(i);t>-1&&this.ongoingStreamedRequests.splice(t,1)}));return this.ongoingStreamedRequests.push(i),i}const n=await z(this.fetch,r,e,{headers:this.config.headers});return await n.json()}async encodeImage(t){if("string"!=typeof t){const e=new Uint8Array(t);let r="";const n=e.byteLength;for(let t=0;t<n;t++)r+=String.fromCharCode(e[t]);return btoa(r)}return t}async generate(t){return t.images&&(t.images=await Promise.all(t.images.map(this.encodeImage.bind(this)))),this.processStreamableRequest("generate",t)}async chat(t){if(t.messages)for(const e of t.messages)e.images&&(e.images=await Promise.all(e.images.map(this.encodeImage.bind(this))));return this.processStreamableRequest("chat",t)}async create(t){return this.processStreamableRequest("create",{...t})}async pull(t){return this.processStreamableRequest("pull",{name:t.model,stream:t.stream,insecure:t.insecure})}async push(t){return this.processStreamableRequest("push",{name:t.model,stream:t.stream,insecure:t.insecure})}async delete(t){return await(async(t,e,r,n)=>{const s=await Y(t,e,{method:"DELETE",body:JSON.stringify(r),headers:n?.headers});return await H(s),s})(this.fetch,`${this.config.host}/api/delete`,{name:t.model},{headers:this.config.headers}),{status:"success"}}async copy(t){return await z(this.fetch,`${this.config.host}/api/copy`,{...t},{headers:this.config.headers}),{status:"success"}}async list(){const t=await V(this.fetch,`${this.config.host}/api/tags`,{headers:this.config.headers});return await t.json()}async show(t){const e=await z(this.fetch,`${this.config.host}/api/show`,{...t},{headers:this.config.headers});return await e.json()}async embed(t){const e=await z(this.fetch,`${this.config.host}/api/embed`,{...t},{headers:this.config.headers});return await e.json()}async embeddings(t){const e=await z(this.fetch,`${this.config.host}/api/embeddings`,{...t},{headers:this.config.headers});return await e.json()}async ps(){const t=await V(this.fetch,`${this.config.host}/api/ps`,{headers:this.config.headers});return await t.json()}};new Z;class K extends Z{async encodeImage(t){if("string"!=typeof t)return Buffer.from(t).toString("base64");try{if(e.existsSync(t)){const n=await e.promises.readFile(r.resolve(t));return Buffer.from(n).toString("base64")}}catch{}return t}async fileExists(t){try{return await e.promises.access(t),!0}catch{return!1}}async create(t){if(t.from&&await this.fileExists(r.resolve(t.from)))throw Error("Creating with a local path is not currently supported from ollama-js");return t.stream,super.create(t)}}new K,c.extend(d);const X={outputPathTemplate:"Summary of Week %WEEK_NUMBER%.md",outputFolder:"/",ollamaApiUrl:"http://localhost:11434",model:"mistral:latest",maxTokens:500};class Q extends t.Plugin{onload(){return n(this,void 0,void 0,(function*(){console.log("Loading Weekly Summarizer Plugin"),yield this.loadSettings(),this.ollamaClient=new K,this.addCommand({id:"generate-weekly-summary",name:"Generate Weekly Summary",callback:()=>n(this,void 0,void 0,(function*(){yield this.generateWeeklySummary()}))}),this.addSettingTab(new tt(this.app,this))}))}generateWeeklySummary(){return n(this,void 0,void 0,(function*(){const e=c().startOf("isoWeek"),r=e.isoWeek(),n=e.year(),s=this.settings.outputPathTemplate.replace("%WEEK_NUMBER%",`${r}`).replace("%YEAR%",`${n}`),i=`${this.settings.outputFolder}/${s}`;if(this.app.vault.getAbstractFileByPath(i)instanceof t.TFile)return void new t.Notice(`Weekly summary for week ${r} already exists. No action taken.`);const o=this.app.vault.getMarkdownFiles(),a=[];for(const t of o)try{const e=yield this.app.vault.read(t),r=yield this.generateShortSummary(e);a.push({content:r,filePath:t.path})}catch(e){console.error(`Error reading ${t.path}: ${e}`)}const u=`${yield this.generateFinalReview(a,r)}`;try{yield this.app.vault.create(i,u),new t.Notice(`Weekly summary for week ${r} generated successfully!`)}catch(e){console.error(`Error writing summary: ${e}`),new t.Notice("Failed to write weekly summary.")}}))}generateShortSummary(t){var e;return n(this,void 0,void 0,(function*(){const r=`Please summarize the following content in one or two concise sentences:\n\n${t}`;try{const t=yield this.ollamaClient.chat({model:this.settings.model,messages:[{role:"user",content:r}],stream:!1});return(null===(e=t.message)||void 0===e?void 0:e.content.trim())||"No summary generated."}catch(t){return console.error(`Error generating short summary: ${t}`),"Error summarizing content."}}))}generateFinalReview(t,e){var r;return n(this,void 0,void 0,(function*(){const n=t.map((({content:t,filePath:e})=>`- ${t} ([Link to document](${e}))`)).join("\n"),s=`Based on the following content, write a two-paragraph weekly review for week ${e}. \nFocus on what was worked on, what was completed, what still needs attention, and any recurring themes or notable patterns.\nInclude relevant links in Markdown format where applicable (links should have this structure [[link]], no escape characters).\n\nContent with links:\n\n${n}`;try{const t=yield this.ollamaClient.chat({model:this.settings.model,messages:[{role:"user",content:s}],stream:!1});return(null===(r=t.message)||void 0===r?void 0:r.content.trim())||"No review generated."}catch(t){return console.error(`Error generating final review: ${t}`),"Error generating review."}}))}loadSettings(){return n(this,void 0,void 0,(function*(){this.settings=Object.assign({},X,yield this.loadData())}))}saveSettings(){return n(this,void 0,void 0,(function*(){yield this.saveData(this.settings)}))}}class tt extends t.PluginSettingTab{constructor(t,e){super(t,e),this.plugin=e}display(){const{containerEl:e}=this;e.empty(),e.createEl("h2",{text:"Weekly Summarizer Settings"}),new t.Setting(e).setName("Output Path Template").setDesc("Template for the output file. Use %WEEK_NUMBER% and %YEAR% as placeholders.").addText((t=>t.setPlaceholder("Summary of Week %WEEK_NUMBER%.md").setValue(this.plugin.settings.outputPathTemplate).onChange((t=>n(this,void 0,void 0,(function*(){this.plugin.settings.outputPathTemplate=t,yield this.plugin.saveSettings()})))))),new t.Setting(e).setName("Output Folder").setDesc("Folder where the summary file will be saved.").addText((t=>t.setPlaceholder("/").setValue(this.plugin.settings.outputFolder).onChange((t=>n(this,void 0,void 0,(function*(){this.plugin.settings.outputFolder=t,yield this.plugin.saveSettings()})))))),new t.Setting(e).setName("Ollama API URL").setDesc("URL for the Ollama API (e.g., http://localhost:11434)").addText((t=>t.setPlaceholder("http://localhost:11434").setValue(this.plugin.settings.ollamaApiUrl).onChange((t=>n(this,void 0,void 0,(function*(){this.plugin.settings.ollamaApiUrl=t,yield this.plugin.saveSettings(),this.plugin.ollamaClient=new K})))))),new t.Setting(e).setName("Ollama Model").setDesc("Model to be used for summarization (e.g., mistral:latest). You must manually pull the model if it does not already exist.").addText((t=>t.setPlaceholder("mistral:latest").setValue(this.plugin.settings.model).onChange((t=>n(this,void 0,void 0,(function*(){this.plugin.settings.model=t,yield this.plugin.saveSettings()})))))),new t.Setting(e).setName("Maximum Tokens").setDesc("Maximum number of tokens to use for each summary request.").addText((t=>t.setPlaceholder("500").setValue(String(this.plugin.settings.maxTokens)).onChange((t=>n(this,void 0,void 0,(function*(){this.plugin.settings.maxTokens=parseInt(t,10),yield this.plugin.saveSettings()}))))))}}module.exports=Q;
//# sourceMappingURL=main.js.map
